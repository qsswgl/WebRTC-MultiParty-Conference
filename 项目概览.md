# WebRTC 实时音频通话应用 - 项目概览

## 📁 项目结构

```
WebRTC/
│
├── 📄 需求文档.txt                    # 原始需求和完成状态
├── 📄 README.md                       # 项目技术文档
├── 📄 使用指南.md                     # 详细使用说明
├── 📄 快速命令.txt                    # 常用命令参考
│
├── 🔧 核心文件
│   ├── Program.cs                     # ASP.NET Core 入口
│   ├── WebRTCApp.csproj              # .NET 项目文件
│   └── appsettings.json              # 应用配置
│
├── 📡 后端代码
│   ├── Hubs/
│   │   └── WebRTCHub.cs              # SignalR Hub（信令服务器）
│   └── Services/
│       └── RoomManager.cs            # 房间管理服务
│
├── 🎨 前端代码
│   └── wwwroot/
│       ├── index.html                # 主页面
│       ├── app.js                    # SignalR客户端 + WebRTC逻辑
│       └── styles.css                # 样式表
│
├── 🐳 Docker配置
│   ├── Dockerfile                    # Docker镜像定义
│   ├── docker-compose.yml            # Docker编排文件
│   └── .dockerignore                 # Docker忽略文件
│
├── 🔐 证书目录
│   └── certs/                        # SSL证书存放位置
│       ├── fullchain.pem             # 完整证书链
│       └── privkey.pem               # 私钥
│
└── 📜 部署脚本
    └── scripts/
        ├── Get-Certificate.ps1       # 证书获取脚本
        └── Deploy.ps1                # 一键部署脚本
```

## 🎯 核心功能实现

### 1. SignalR 信令服务器 (Hubs/WebRTCHub.cs)

负责WebRTC信令交换：
- ✅ 房间创建和加入
- ✅ SDP Offer/Answer 转发
- ✅ ICE候选交换
- ✅ 用户连接管理
- ✅ 自动重连支持

**主要方法：**
```csharp
CreateRoom(userId)              // 创建房间
JoinRoom(roomId, userId)        // 加入房间
SendOffer(targetUserId, offer)  // 发送Offer
SendAnswer(targetUserId, answer)// 发送Answer
SendIceCandidate(target, cand)  // 发送ICE候选
LeaveRoom()                     // 离开房间
```

### 2. 房间管理 (Services/RoomManager.cs)

管理聊天室和用户连接：
- ✅ 并发安全的房间字典
- ✅ 用户连接状态跟踪
- ✅ 自动清理空房间
- ✅ 房间人数限制（2人）

### 3. WebRTC客户端 (wwwroot/app.js)

前端WebRTC实现：
- ✅ SignalR连接管理
- ✅ WebRTC PeerConnection
- ✅ 音频流采集和播放
- ✅ 增强音频优化配置
- ✅ 音频电平可视化
- ✅ 自动重连机制

**音频优化参数：**
```javascript
{
    echoCancellation: true,           // 标准回声消除
    googEchoCancellation2: true,      // Google增强回声消除
    noiseSuppression: true,            // 噪声抑制
    googNoiseSuppression2: true,       // Google增强噪声抑制
    autoGainControl: true,             // 自动增益
    googAutoGainControl2: true,        // Google增强增益
    googHighpassFilter: true,          // 高通滤波器
    googTypingNoiseDetection: true,    // 打字噪声检测
    sampleRate: 48000,                 // 48kHz采样率
    latency: 0                         // 低延迟模式
}
```

## 🚀 部署流程

### 自动化部署 (scripts/Deploy.ps1)

```
1. 证书获取
   └─> 调用 Get-Certificate.ps1
   └─> 从API获取SSL证书
   └─> 保存到 certs/ 目录

2. 文件准备
   └─> 复制项目文件
   └─> 打包到临时目录

3. SSH上传
   └─> 使用密钥连接服务器
   └─> 上传到 /opt/webrtc-app

4. Docker部署
   └─> docker-compose down
   └─> docker-compose build
   └─> docker-compose up -d

5. 验证
   └─> 检查容器状态
   └─> 显示日志
```

### 证书获取 (scripts/Get-Certificate.ps1)

```
1. 调用证书API
   POST http://tx.qsgl.net:5074/api/request-cert
   Body: { domain: "*.qsgl.net" }

2. 保存证书文件
   ├─> fullchain.pem  (完整证书链)
   ├─> privkey.pem    (私钥)
   ├─> cert.pem       (证书)
   └─> chain.pem      (中间证书)
```

## 📊 技术架构

```
┌─────────────────────────────────────────────────────┐
│                   用户浏览器/微信                     │
│  ┌──────────────┐              ┌──────────────┐    │
│  │   HTML/CSS   │              │   WebRTC     │    │
│  │   界面显示   │◄────────────►│   P2P音频    │    │
│  └──────────────┘              └──────────────┘    │
│         │                             │             │
│         │                             │             │
│         ▼                             ▼             │
│  ┌──────────────────────────────────────────┐      │
│  │     SignalR Client (app.js)              │      │
│  │  - 连接管理                               │      │
│  │  - 信令交换                               │      │
│  │  - 音频优化配置                           │      │
│  └──────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────┘
                        │
                        │ WebSocket/HTTPS
                        ▼
┌─────────────────────────────────────────────────────┐
│              tx.qsgl.net:8096 服务器                 │
│  ┌──────────────────────────────────────────┐      │
│  │    ASP.NET Core + SignalR Hub            │      │
│  │  - WebRTC信令服务器                       │      │
│  │  - 房间管理                               │      │
│  │  - 用户连接管理                           │      │
│  └──────────────────────────────────────────┘      │
│         │                                           │
│         ▼                                           │
│  ┌──────────────────────────────────────────┐      │
│  │         RoomManager Service              │      │
│  │  - ConcurrentDictionary<Room>            │      │
│  │  - ConcurrentDictionary<UserConnection>  │      │
│  └──────────────────────────────────────────┘      │
│                                                      │
│  运行在Docker容器中                                  │
└─────────────────────────────────────────────────────┘
```

## 🔒 安全特性

1. **HTTPS加密**
   - 所有通信使用TLS/SSL
   - qsgl.net泛域名证书

2. **WebRTC加密**
   - DTLS-SRTP加密音频流
   - 端到端加密

3. **房间安全**
   - 随机生成房间ID
   - 难以猜测的8位标识符

4. **连接安全**
   - SSH密钥认证
   - 无需密码登录

## 📈 性能指标

| 指标 | 数值 |
|------|------|
| 音频延迟 | < 200ms |
| 连接建立时间 | < 2秒 |
| 内存占用 | ~50MB/容器 |
| CPU使用 | 1-5% (空闲) |
| 带宽需求 | ~50 Kbps |
| 音频质量 | 48kHz单声道 |
| 并发用户 | 受服务器资源限制 |

## 🎓 使用场景

1. **客服语音支持**
   - 客户通过微信链接快速接入
   - 无需安装APP
   - 实时语音沟通

2. **远程咨询**
   - 专业人员提供语音咨询
   - 简单快捷的接入方式
   - 高质量音频效果

3. **在线客服**
   - 网站集成语音通话
   - 降低沟通成本
   - 提升用户体验

## ⚙️ 配置说明

### appsettings.json

```json
{
  "Logging": {
    "LogLevel": {
      "Microsoft.AspNetCore.SignalR": "Information"
    }
  },
  "CertPath": "/app/certs"  // Docker容器内证书路径
}
```

### docker-compose.yml

```yaml
services:
  webrtc-app:
    ports:
      - "8096:8096"          # HTTPS端口映射
    volumes:
      - ./certs:/app/certs:ro  # 只读挂载证书
    environment:
      - CertPath=/app/certs
```

## 🛠️ 维护指南

### 日常维护

1. **查看日志**
   ```powershell
   docker-compose logs -f
   ```

2. **重启服务**
   ```powershell
   docker-compose restart
   ```

3. **更新代码**
   ```powershell
   .\scripts\Deploy.ps1
   ```

### 证书更新

证书过期时重新获取：
```powershell
.\scripts\Get-Certificate.ps1
```

然后重新部署：
```powershell
.\scripts\Deploy.ps1
```

### 备份建议

定期备份以下内容：
- 源代码
- 证书文件 (certs/)
- 配置文件

## 📞 故障排查

### 常见问题解决

**问题1: 无法连接SignalR**
```
检查: docker-compose logs
确认: 容器是否正常运行
测试: curl https://tx.qsgl.net:8096
```

**问题2: 麦克风无权限**
```
原因: HTTPS必需
解决: 确保使用HTTPS访问
检查: 浏览器权限设置
```

**问题3: WebRTC连接失败**
```
检查: 浏览器控制台ICE状态
确认: STUN服务器可访问
测试: 网络防火墙设置
```

## 🎉 项目优势

1. ✅ **简单易用** - 一键部署，无需复杂配置
2. ✅ **高质量音频** - 多重优化，回声消除
3. ✅ **微信友好** - 完美支持微信内访问
4. ✅ **安全可靠** - HTTPS + WebRTC加密
5. ✅ **易于维护** - Docker容器化部署
6. ✅ **自动重连** - SignalR断线自动恢复
7. ✅ **现代技术栈** - .NET 8 + SignalR + WebRTC

---

**项目完成时间**: 2025年10月20日  
**技术栈**: .NET 8 + SignalR + WebRTC  
**部署地址**: https://tx.qsgl.net:8096
