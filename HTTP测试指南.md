# WebRTC 应用 HTTP 测试指南

## 🌐 访问地址
**HTTP 地址**: http://tx.qsgl.net:8096

⚠️ **重要提示**: 
- HTTP 模式下浏览器可能会限制麦克风和摄像头访问
- 建议使用 Chrome/Edge 浏览器测试
- 某些浏览器需要允许"不安全内容"才能访问音视频设备

## 📋 测试步骤

### 1. 创建聊天室
1. 打开浏览器访问: http://tx.qsgl.net:8096
2. 点击 **"创建聊天室"** 按钮
3. 系统会自动生成房间 ID
4. 复制分享链接

### 2. 加入聊天室
**方法一**: 使用分享链接
- 在另一个浏览器窗口/设备打开分享链接

**方法二**: 手动输入房间号
- 在首页输入框输入房间 ID
- 点击 **"加入聊天室"** 按钮

### 3. 音频通话测试
1. 双方加入同一房间后
2. 浏览器会请求麦克风权限,点击 **"允许"**
3. 等待 WebRTC 连接建立(约 2-5 秒)
4. 连接状态显示为 **"通话中"** (绿色)
5. 测试说话,查看音量指示器是否跳动

### 4. 视频通话测试
1. 在音频通话基础上
2. 点击 **"开启视频"** 按钮
3. 浏览器会请求摄像头权限,点击 **"允许"**
4. 本地视频会出现在右下角(画中画)
5. 对方视频会显示在主窗口

### 5. 静音功能测试
- 点击 **"静音"** 按钮:麦克风图标变灰,对方听不到声音
- 再次点击恢复

### 6. 关闭视频测试
- 点击 **"关闭视频"** 按钮
- 本地和远程视频窗口消失,保持音频通话

## 🔍 功能检查清单

### 基础功能
- [ ] 创建房间成功
- [ ] 生成分享链接
- [ ] 加入房间成功
- [ ] SignalR 连接建立(查看控制台日志)

### 音频功能
- [ ] 麦克风权限获取
- [ ] 本地音频采集(音量条跳动)
- [ ] 远程音频播放(能听到对方声音)
- [ ] 静音/取消静音功能
- [ ] 回声消除效果(说话不会有回音)

### 视频功能 (新增)
- [ ] 默认纯语音模式
- [ ] 手动开启视频
- [ ] 摄像头权限获取
- [ ] 本地视频显示(右下角)
- [ ] 远程视频显示(主窗口)
- [ ] 关闭视频功能
- [ ] 视频清晰度(720p/30fps)

### 连接稳定性
- [ ] 连接状态正确显示
- [ ] 断线重连机制
- [ ] 对方离开提示
- [ ] 离开房间功能

## 🐛 常见问题排查

### 问题1: 麦克风/摄像头访问被拒绝
**原因**: HTTP 不是安全上下文,浏览器限制音视频访问

**解决方案**:
- **Chrome/Edge**: 地址栏右侧点击锁🔒图标 → 网站设置 → 允许摄像头和麦克风
- **Firefox**: 临时允许不安全内容
- **最终方案**: 配置 HTTPS (需要 SSL 证书)

### 问题2: 无法听到对方声音
**检查**:
1. 浏览器控制台是否有错误
2. 远程音频元素是否有流:`remoteAudio.srcObject`
3. 浏览器音量是否静音
4. 检查防火墙/网络配置

### 问题3: 连接一直是"正在连接"
**检查**:
1. SignalR Hub 连接状态(F12 控制台)
2. WebRTC ICE 连接状态
3. STUN/TURN 服务器连通性
4. 防火墙是否阻止 UDP 流量

### 问题4: 视频无法显示
**检查**:
1. 摄像头是否被其他应用占用
2. 浏览器控制台错误信息
3. 视频轨道是否成功添加: `peerConnection.getSenders()`
4. HTTP 权限是否允许摄像头访问

## 📊 浏览器控制台日志

打开开发者工具(F12),查看关键日志:

### 成功连接日志示例:
```
SignalR 已连接
本地媒体流获取成功
已创建房间: ABC123
WebRTC 对等连接已创建
音频轨道已添加
收到远程流: audio
通话已建立
```

### 视频开启日志示例:
```
开启视频
音频轨道已添加
视频轨道已添加
收到远程流: video
```

## 🔧 HTTP vs HTTPS 功能对比

| 功能 | HTTP | HTTPS |
|------|------|-------|
| SignalR 连接 | ✅ | ✅ |
| 房间创建/加入 | ✅ | ✅ |
| 麦克风访问 | ⚠️ 需手动允许 | ✅ 正常 |
| 摄像头访问 | ⚠️ 需手动允许 | ✅ 正常 |
| 音频通话 | ✅ | ✅ |
| 视频通话 | ⚠️ 受限 | ✅ |
| 微信内访问 | ❌ 无法使用音视频 | ✅ 完全支持 |
| 分享链接 | ✅ | ✅ |

## 📝 测试报告模板

```
测试时间: __________
浏览器: __________
测试人员: __________

功能测试:
✅/❌ 房间创建
✅/❌ 房间加入
✅/❌ 音频通话
✅/❌ 视频通话
✅/❌ 静音功能
✅/❌ 断线重连

音视频质量:
- 音质: 清晰 / 一般 / 嘈杂
- 延迟: <500ms / 500-1000ms / >1000ms
- 回声: 无 / 轻微 / 明显
- 视频清晰度: 清晰 / 一般 / 模糊
- 视频流畅度: 流畅 / 卡顿

问题记录:
1. __________
2. __________

备注:
__________
```

## 🚀 下一步计划

### 短期目标 (HTTP 测试完成后)
1. ✅ 验证 SignalR 信令服务器工作正常
2. ✅ 验证 WebRTC P2P 连接建立
3. ✅ 验证音视频基本功能
4. ⏳ 记录所有 HTTP 限制和问题

### 中期目标 (解决证书问题)
1. 🔍 调试证书 API: http://tx.qsgl.net:5074/api/request-cert
2. 🔍 联系 API 提供者解决 500 错误
3. 或者使用备选方案:
   - Let's Encrypt 免费证书
   - 手动生成 CSR 并申请证书
   - 使用 Cloudflare 证书

### 长期目标 (HTTPS 配置)
1. 📋 获取 qsgl.net 泛域名证书
2. 📋 配置 Kestrel HTTPS 端口
3. 📋 更新 docker-compose.yml 挂载证书
4. 📋 测试 https://tx.qsgl.net:8096
5. 📋 微信内分享测试

## 🎯 成功标准

### HTTP 测试通过标准:
- 两个不同浏览器能成功建立音频通话
- 音质清晰,无明显回声
- 连接稳定,不频繁断线
- 视频能手动开启(即使需要权限设置)
- 所有按钮和状态显示正常

### 准备进入 HTTPS 配置:
- HTTP 功能全部验证通过
- 确认架构和代码无问题
- 证书获取方案明确

---

**测试愉快!** 🎉

有任何问题请查看浏览器控制台日志或联系技术支持。
